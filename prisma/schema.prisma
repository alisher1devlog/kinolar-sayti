generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  SUPERADMIN
}

enum Status {
  ACTIVE 
  INACTIVE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
  PENDING_PAYMENT
}

enum PaymentMethod {
  CARD
  PAYPAL
  BANK_TRANSFER
  CRYPTO
}

enum PaymentStatus {
  PENDING_PAYMENT
  COMPLETED
  FAILED
  REFUNDED
}

enum SubscriptionType {
  FREE 
  PREMIUM
}

enum Quality {
  P240
  P360
  P480
  P720
  P1080
  K4
}

model User {
  id String @id @default(uuid())
  user_name String @unique
  email String @unique
  password_hash String 
  role Role @default(USER)
  is_active        Boolean  @default(false)
  activation_token String?
  avatar_url String?
  created_at DateTime @default(now())

  profile Profile?
  subscriptions UserSubscription[]
  favorites Favorite[]
  reviews Review[]
  watch_history WatchHistory[]
  created_movies Movie[] @relation("AdminCreated")

  @@map("users")
}

model Profile {
  id String @id @default(uuid())
  full_name String?
  phone String?
  country String?
  updated_at DateTime @updatedAt

  user_id String @unique
  user User @relation(fields: [user_id],references: [id])
  @@map("profiles")
}

model SubscriptionPlan {
  id String @id @default(uuid())
  name String 
  price Decimal @db.Decimal(10,2)
  duration_days Int 
  features Json
  is_active Status @default(INACTIVE)

  subscriptions UserSubscription[]

  @@map("subscription_plans")
}

model UserSubscription {
  id String @id @default(uuid())
  user_id String 
  user User @relation(fields: [user_id], references: [id])
  plan_id String 
  plan SubscriptionPlan @relation(fields: [plan_id], references: [id])

  start_date DateTime @default(now())
  end_date DateTime?
  status SubscriptionStatus @default(PENDING_PAYMENT)
  auto_renew Boolean @default(false)
  created_at DateTime @default(now())

  payments Payment[]

  @@map("user_subscriptions")
}

model Payment {
  id String @id @default(uuid())
  user_subscription_id String
  subscription   UserSubscription @relation(fields: [user_subscription_id], references: [id])

  amount Decimal @db.Decimal(10, 2)
  payment_method PaymentMethod
  payment_details Json
  status PaymentStatus @default(PENDING_PAYMENT)
  external_transaction_id String?
  created_at DateTime @default(now())

  @@map("payments")
}

model Category {
  id String @id @default(uuid())
  name String 
  slug String @unique
  description String?

  movies MovieCategory[]

  @@map("categories")
}

model Movie {
  id String @id @default(uuid())
  title String 
  slug String @unique
  description String?
  release_year Int
  duration_minutes Int?
  poster_url String?
  rating Decimal? @db.Decimal(3, 1)
  subscription_type SubscriptionType @default(FREE)
  view_count Int @default(0)

  created_by       String?
  creator          User?             @relation("AdminCreated", fields: [created_by], references: [id])
  created_at DateTime @default(now())

  categories MovieCategory[]
  files MovieFile[]
  favorites Favorite[]
  reviews Review[]
  watch_history WatchHistory[]

  @@map("movies")
}

model MovieCategory {
  id String @id @default(uuid())
  movie_id String 
  movie Movie @relation(fields: [movie_id], references: [id])
  category_id String 
  category Category @relation(fields: [category_id], references: [id])

  @@unique([movie_id,category_id])
  @@map("movie_categories")
}

model MovieFile {
  id String @id @default(uuid())
  movie_id String 
  movie Movie @relation(fields: [movie_id],references: [id])
  file_url String
  quality Quality 
  language String @default("uz")

}

model Favorite {
  id String @id @default(uuid())
  user_id String 
  user User @relation(fields: [user_id], references: [id])
  movie_id String 
  movie Movie @relation(fields: [movie_id], references: [id])
  created_at DateTime @default(now())

  @@unique([user_id,movie_id])
  @@map("favorites")
}

model Review {
  id String @id @default(uuid())
  user_id String 
  user User @relation(fields: [user_id], references: [id])
  movie_id String 
  movie Movie @relation(fields: [movie_id], references: [id])
  rating Int  
  comment String? @db.Text
  created_at DateTime @default(now())

  @@map("reviews")
}

model WatchHistory {
  id String @id @default(uuid())
  user_id String 
  user User @relation(fields: [user_id], references: [id])
  movie_id String 
  movie Movie @relation(fields: [movie_id], references: [id])

  watched_duration Int?
  watched_percentage Decimal? @db.Decimal(5, 2)
  last_watched DateTime @default(now())

  @@map("watch_history")
}



